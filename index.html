<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EggZip</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: sans-serif;
    background: var(--bg);
    color: var(--fg);
    margin: 0;
    padding: 0;
}
:root {
    --bg: #ffffff;
    --fg: #000000;
    --panel: #f0f0f0;
    --button: #e0e0e0;
}
body.dark {
    --bg: #121212;
    --fg: #f5f5f5;
    --panel: #1d1d1d;
    --button: #333333;
}

header {
    text-align: center;
    padding: 20px;
}
#logo {
    width: 128px;
    height: auto;
    image-rendering: pixelated;
}
#tagline {
    font-size: 1.1em;
    margin-top: 5px;
}

#modeToggle {
    position: fixed;
    right: 10px;
    top: 10px;
    background: var(--button);
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
}

main {
    padding: 20px;
}

.panel {
    background: var(--panel);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

input[type=file] {
    width: 100%;
}

button {
    padding: 12px;
    width: 100%;
    margin-top: 10px;
    background: var(--button);
    border: none;
    border-radius: 10px;
    cursor: pointer;
}

#output {
    white-space: pre-wrap;
    margin-top: 10px;
}

footer {
    text-align: center;
    padding: 20px;
    opacity: 0.7;
    font-size: 0.9em;
}
</style>
</head>

<body>

<div id="modeToggle">Toggle mode</div>

<header>
    <img id="logo" alt="EggZip Logo"
    src="data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAI AAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAA
AlwSFlzAAALEgAACxIB0t1+/AAAABl0RVh0Q3JlYXRpb24gVGltZQAwMi8xMi8xNTZRwaMA
AAE4SURBVHic7dqxCcMgEEVRx///5yoyS9MhUlCT3VkOqkk58FmSPrbr30YIOCQM7DDDeWG
ZPAHDLcBYcAUcATcAQcAadwHIAcUAacwHYAceAGdwGMY4YAlnXrhIRbkIuAeGHWxirMRqkR
sADVY6jwxKF1uHmIiiaivGi4ZTSdKCbFf8gDuwZQzQPgimeISFRCGDpa2BkLomqKgkl0aoV
UgG0KBPXn1HULICwhfQ3GscxCiNFuIBqmoeZaR6mE6oPD58Ll35H0TADaBrZEcDgEaKhsR4
Y90SEzGyF/F7Ai/3Gzdh0dX8GZFODdgNpTi27CwBZhOiCkCmDYJLQCxBmA5g2C60AsQZgOY
NgbuALIGYDmHYFLQawBmA5hWBW0CsAZgOYXgVtArAGYDmFYFbQKwBmA5heBW0CsAZgOYXgV
vAHzW0Ax7AnCM1j7rwhhtjfiPgkBC5Qyjp/wAAAABJRU5ErkJggg==" />

    <div id="tagline">Get to the yolk inside!</div>
</header>

<main>

<div class="panel">
    <h2>Create archive</h2>
    <input id="createInput" type="file" multiple>
    <select id="createFormat">
        <option value="zip">zip</option>
        <option value="7z">7z</option>
    </select>
    <button onclick="createArchive()">Create archive</button>
</div>

<div class="panel">
    <h2>Extract archive</h2>
    <input id="extractInput" type="file">
    <button onclick="extractArchive()">Extract</button>
</div>

<div id="output" class="panel"></div>

</main>

<footer>
Created by Dan
</footer>

<script>
// Light or dark mode
document.getElementById("modeToggle").onclick = () => {
    document.body.classList.toggle("dark");
};

// Lazy loading
async function loadScript(url) {
    return new Promise((resolve) => {
        const s = document.createElement("script");
        s.src = url;
        s.onload = resolve;
        document.body.appendChild(s);
    });
}

// Create archive
async function createArchive() {
    const files = document.getElementById("createInput").files;
    if (!files.length) return;

    const format = document.getElementById("createFormat").value;

    if (format === "zip") {
        // Use CompressionStream API
        const cs = new CompressionStream("gzip"); 
        const writer = cs.writable.getWriter();

        let combined = "";
        for (const f of files) {
            const text = await f.text();
            combined += "FILE: " + f.name + "\n" + text + "\n";
        }

        writer.write(new TextEncoder().encode(combined));
        writer.close();

        const blob = await new Response(cs.readable).blob();
        download(blob, "archive.zip");
        document.getElementById("output").textContent = "Created zip using CompressionStream.";
    }

    if (format === "7z") {
        await loadScript("https://cdn.jsdelivr.net/npm/7z-wasm/7zwasm.js");

        const seven = await SevenZip.create({});
        const fileMap = {};
        for (const f of files) fileMap[f.name] = new Uint8Array(await f.arrayBuffer());

        const result = await seven.add(fileMap, "output.7z");
        download(new Blob([result]), "output.7z");
        document.getElementById("output").textContent = "Created 7z archive using 7zwasm.";
    }
}

// Extract archive
async function extractArchive() {
    const file = document.getElementById("extractInput").files[0];
    if (!file) return;

    const name = file.name.toLowerCase();

    if (name.endsWith(".zip") || name.endsWith(".gz")) {
        try {
            const ds = new DecompressionStream("gzip");
            const decompressed = file.stream().pipeThrough(ds);
            const text = await new Response(decompressed).text();
            document.getElementById("output").textContent = text;
        } catch (e) {
            document.getElementById("output").textContent =
            "Unable to extract zip using CompressionStream.";
        }
        return;
    }

    // Use libarchive.js
    await loadScript("https://unpkg.com/libarchive.js/dist/libarchive.js");

    const archive = await Archive.open(file);
    const entries = await archive.getFilesArray();

    let output = "";
    entries.forEach(e => {
        output += "----- " + e.filepath + " -----\n";
        output += new TextDecoder().decode(e.filedata) + "\n";
    });

    document.getElementById("output").textContent = output;
}

// Helper for saving files
function download(blob, filename) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}
</script>

</body>
</html>
